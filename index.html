<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dropbox File Selector (Single File)</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Dropbox Chooser Script -->
    <!-- আপনার আসল Dropbox App Key এখানে ব্যবহার করুন -->
    <script type="text/javascript" src="https://www.dropbox.com/static/api/2/dropins.js" id="dropboxjs" data-app-key="317alyycs84fbvu"></script>

    <style>
        /* --- Custom CSS --- */
        .card-img-top {
            height: 200px;        /* ছবির উচ্চতা নির্দিষ্ট করা */
            object-fit: cover;    /* ছবিকে কন্টেইনারে ফিট করা, অতিরিক্ত অংশ কেটে ফেলা */
            border-bottom: 1px solid #ddd; /* ছবির নিচে একটি হালকা বর্ডার */
        }
         .preview-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f8f9fa; /* হালকা ধূসর الخلفية */
            color: #6c757d; /* ধূসর টেক্সট */
            font-style: italic;
            border-bottom: 1px solid #ddd;
        }

        #dropbox-button {
          /* প্রয়োজন অনুযায়ী স্টাইল যোগ করতে পারেন */
        }
    </style>
</head>
<body>

    <h1 class="text-center my-4">Dropbox File Selector</h1>

    <div class="text-center mb-4">
        <!-- Dropbox Chooser বাটন -->
        <button id="dropbox-button" class="btn btn-primary">Select Files</button>
    </div>

    <div class="container my-5">
        <div class="row" id="file-list">
            <!-- নির্বাচিত ফাইলগুলো এখানে কার্ড আকারে যুক্ত হবে -->
        </div>
    </div>

    <script>
        // --- JavaScript Code ---

        // Dropbox App Key (React কোডের মতোই)
        // নিশ্চিত করুন data-app-key উপরের script ট্যাগে সঠিক আছে
        // const DROPBOX_APP_KEY = "317alyycs84fbvu"; // এখানে প্রয়োজন নেই কারণ script ট্যাগে দেওয়া আছে

        // DOM এলিমেন্টগুলো ধরা
        const dropboxButton = document.getElementById('dropbox-button');
        const fileListContainer = document.getElementById('file-list');

        // --- Dropbox Chooser কনফিগারেশন ---
        const options = {
            // ব্যবহারকারী ফাইল সিলেক্ট করলে এই ফাংশন কল হবে
            success: function(files) {
                // আগের ফাইল লিস্ট খালি করা
                fileListContainer.innerHTML = '';

                // প্রতিটি সিলেক্ট করা ফাইলের জন্য কার্ড তৈরি করা
                files.forEach(file => {
                    const fileCard = createFileCard(file);
                    fileListContainer.appendChild(fileCard);
                });
            },

            // ব্যবহারকারী Chooser ক্যানসেল করলে এই ফাংশন কল হবে
            cancel: function() {
                console.log("User canceled the operation.");
            },

            // লিঙ্ক টাইপ - 'direct' মানে সরাসরি ডাউনলোডের লিঙ্ক দেবে
            linkType: "direct", // অথবা "preview"

            // একাধিক ফাইল সিলেক্ট করা যাবে কিনা
            multiselect: true,

            // ফাইলের এক্সটেনশন অনুযায়ী ফিল্টার করতে চাইলে (ঐচ্ছিক)
            // extensions: ['.pdf', '.doc', '.docx', 'images'],
        };

        // বাটন ক্লিকের মাধ্যমে Dropbox Chooser খোলা
        dropboxButton.addEventListener('click', () => {
            // Dropbox SDK লোড হয়েছে কিনা তা নিশ্চিত করতে Dropbox অবজেক্ট পরীক্ষা করা যেতে পারে
            if (typeof Dropbox !== 'undefined') {
                Dropbox.choose(options);
            } else {
                console.error("Dropbox SDK not loaded yet.");
                alert("Error: Could not connect to Dropbox. Please try again later.");
            }
        });


        // --- ফাইল কার্ড তৈরি করার ফাংশন ---
        function createFileCard(file) {
            // কার্ডের জন্য কলাম তৈরি
            const col = document.createElement('div');
            col.className = 'col-md-4 mb-4';

            // কার্ড এলিমেন্ট তৈরি
            const card = document.createElement('div');
            card.className = 'card h-100'; // h-100 ক্লাস কার্ডগুলোর উচ্চতা সমান রাখতে সাহায্য করবে

            let imageOrPlaceholderHtml = '';
            // থাম্বনেইল বা ছবি লিঙ্ক থাকলে এবং ফাইলটি যদি ইমেজ হয়
             if (file.thumbnailLink && /\.(jpe?g|png|gif|bmp|webp)$/i.test(file.name)) {
                 imageOrPlaceholderHtml = `<img src="${file.thumbnailLink}?size=256x256" class="card-img-top" alt="${file.name}">`; // থাম্বনেইলের সাইজ নির্দিষ্ট করা যেতে পারে
             } else if (file.link && /\.(jpe?g|png|gif|bmp|webp)$/i.test(file.name)) {
                 // থাম্বনেইল না থাকলে কিন্তু ছবির ফাইল হলে, সরাসরি লিঙ্ক (ছোট ফাইলের জন্য ঠিক আছে)
                 imageOrPlaceholderHtml = `<img src="${file.link}" class="card-img-top" alt="${file.name}">`;
             }
             else {
                // অন্য কোনো ফাইল বা ফোল্ডার হলে একটি placeholder দেখানো
                imageOrPlaceholderHtml = `<div class="preview-placeholder">No preview available</div>`;
            }

            // ফাইলের সাইজ KB তে কনভার্ট করা (ফোল্ডারের জন্য বাইট নাও থাকতে পারে)
            const fileSizeKB = file.bytes ? (file.bytes / 1024).toFixed(2) + ' KB' : 'N/A';

            // কার্ডের ভেতরের অংশ (body)
            card.innerHTML = `
                ${imageOrPlaceholderHtml}
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">${file.name}</h5>
                    <p class="card-text">
                        <strong>Size:</strong> ${fileSizeKB}
                    </p>
                    ${file.isDir ? '' : // যদি ফোল্ডার না হয় তবেই ডাউনলোড বাটন দেখাবে
                    `<button class="btn btn-success mt-auto download-button" data-link="${file.link}" data-name="${file.name}">
                        Download
                    </button>`
                    }
                </div>
            `;

            col.appendChild(card);
            return col;
        }

        // --- ডাউনলোড বাটন হ্যান্ডেল করা (Event Delegation ব্যবহার করে) ---
        fileListContainer.addEventListener('click', function(event) {
            // যদি ক্লিক করা এলিমেন্টটি ডাউনলোড বাটন হয়
            const button = event.target.closest('.download-button'); // বাটন বা তার ভেতরের কিছুতে ক্লিক হলেও কাজ করবে
            if (button) {
                const link = button.getAttribute('data-link');
                const name = button.getAttribute('data-name');

                if (link && name) {
                    handleDownload(link, name);
                }
            }
        });

        // --- ফাইল ডাউনলোড ফাংশন ---
        function handleDownload(link, name) {
            console.log(`Attempting download: ${name} from ${link}`);
            const anchor = document.createElement('a');
            // Dropbox direct link অনেক সময় সরাসরি ডাউনলোডের জন্য কাজ করে না,
            // সে ক্ষেত্রে '?dl=1' যোগ করা যেতে পারে URL-এর শেষে।
             // নিশ্চিত করুন যে '?dl=0' বা '?dl=false' নেই এবং '?dl=1' যোগ করুন
            let downloadLink = link.replace(/(\?dl=)[0|false]/, '').replace(/$/, '?dl=1');
            if (!downloadLink.includes('?dl=1')) {
                downloadLink += (downloadLink.includes('?') ? '&' : '?') + 'dl=1';
            }

            anchor.href = downloadLink;
            anchor.download = name; // এই attribute ফাইল ডাউনলোড করতে ব্রাউজারকে নির্দেশ দেয়
            document.body.appendChild(anchor); // DOM এ যুক্ত করা আবশ্যক (কিছু ব্রাউজারের জন্য)
            anchor.click();
            document.body.removeChild(anchor); // কাজ শেষে এলিমেন্টটি সরিয়ে ফেলা
        }
    </script>

    <!-- Bootstrap Bundle JS (Optional, for Bootstrap features like dropdowns, modals, etc.) -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script> -->
</body>
</html>
